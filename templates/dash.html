<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Smart Med Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f8f9fa;
    }
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 260px;
      z-index: 100;
      padding: 48px 0 0;
      box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
      background-color: #fff;
    }
    .main-content {
      margin-left: 260px;
      padding: 20px;
    }
    .sidebar-sticky {
      position: relative;
      top: 0;
      height: calc(100vh - 48px);
      padding-top: .5rem;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .nav-link { color: #333; }
    .nav-link.active { color: #0d6efd; font-weight: 500; }
    .nav-link .fa-fw { width: 1.25em; }
    .kpi-card {
        border-left-width: 4px;
        border-radius: .375rem;
    }
    .kpi-icon {
        font-size: 2rem;
        opacity: 0.3;
    }

    /* --- Skeleton Loader Styles --- */
    .skeleton-loader { display: none; }
    .skeleton {
        animation: shimmer 1.5s infinite linear;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        border-radius: .25rem;
    }
    .skeleton-text { height: 1em; margin-bottom: .5em; }
    .skeleton-text-lg { height: 1.5em; width: 60%; }
    .skeleton-row { display: flex; gap: 1rem; align-items: center; }
    .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>

<nav class="sidebar">
  <div class="sidebar-sticky d-flex flex-column">
    <div class="px-4 py-3">
        <a class="navbar-brand fw-bold fs-4" href="#"><i class="fa-solid fa-cubes-stacked me-2"></i>Smart Med</a>
    </div>
    <ul class="nav flex-column px-2">
      <li class="nav-item"><a class="nav-link active" href="#"><i class="fa-solid fa-chart-line fa-fw me-2"></i> Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="/users/history"><i class="fa-solid fa-users fa-fw me-2"></i> User History</a></li>
    </ul>
    <div class="mt-auto p-3 border-top">
        <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-circle-user fs-3 text-muted"></i>
            <div>
                <span class="fw-semibold d-block">{% if is_admin %}Admin User{% else %}User{% endif %}</span>
                {% if is_admin %}<span class="badge bg-dark small">ADMIN</span>{% endif %}
            </div>
            <a href="/logout" class="btn btn-outline-danger btn-sm ms-auto" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></a>
        </div>
    </div>
  </div>
</nav>

<main class="main-content">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-dark">üíä Dashboard</h1>
    <div class="d-flex gap-2 align-items-center">
      <label for="rangeSel" class="small text-muted">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
      <select id="rangeSel" class="form-select form-select-sm" style="width:auto">
        <option value="day">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
        <option value="week">7 ‡∏ß‡∏±‡∏ô</option>
        <option value="month" selected>30 ‡∏ß‡∏±‡∏ô</option>
        <option value="year">1 ‡∏õ‡∏µ</option>
      </select>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-4 skeleton-loader"><div class="card shadow-sm"><div class="card-body"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text-lg"></div></div></div></div>
    <div class="col-md-4 skeleton-loader"><div class="card shadow-sm"><div class="card-body"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text-lg"></div></div></div></div>
    <div class="col-md-4 skeleton-loader"><div class="card shadow-sm"><div class="card-body"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text-lg"></div></div></div></div>
    <div id="kpi-cards-container" class="row g-4 m-0"></div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">Dispensed per Period</div>
        <div class="card-body position-relative">
          <div class="skeleton-loader h-100"><div class="skeleton h-100"></div></div>
          <canvas id="dailyChart" style="display: none;"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">Top Medicines (by range)</div>
        <div class="card-body">
          <div class="skeleton-loader"><div class="skeleton skeleton-text w-100 mb-2"></div><div class="skeleton skeleton-text w-100 mb-2"></div><div class="skeleton skeleton-text w-100"></div></div>
          <ol id="topList" class="list-group list-group-flush"></ol>
        </div>
      </div>
    </div>
    
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-boxes-stacked me-2"></i>Stock (Medicines)</span>
          <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#refillModal"><i class="fa-solid fa-plus me-1"></i> Refill</button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover text-center align-middle small mb-0">
              <thead class="table-light"><tr><th>Slot</th><th class="text-start">Medicine</th><th>Stock</th><th>Threshold</th><th>Status</th></tr></thead>
              <tbody id="stockTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>Recent Users</span>
          <a href="/users/history" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body p-0">
          <div class="skeleton-loader p-3">
            <div class="skeleton-row mb-3"><div class="skeleton skeleton-avatar"></div><div class="w-100"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text w-75"></div></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-avatar"></div><div class="w-100"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text w-75"></div></div></div>
          </div>
          <ul id="recentList" class="list-group list-group-flush small"></ul>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="refillModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="refillForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤</label>
          <select id="refillMedicine" name="medicine_id" class="form-select" required></select>
        </div>
        <div class="mb-2">
          <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°</label>
          <input id="refillQty" name="qty" type="number" min="1" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
        <button type="submit" class="btn btn-primary" id="refillSubmitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ---------- element refs ---------- */
const kpiContainer  = document.getElementById('kpi-cards-container');
const topList       = document.getElementById('topList');
const recentList    = document.getElementById('recentList');
const stockTbody    = document.getElementById('stockTbody');
const refillMedicine= document.getElementById('refillMedicine');
const rangeSel      = document.getElementById('rangeSel');
const skeletons     = document.querySelectorAll('.skeleton-loader');
const chartCanvas   = document.getElementById('dailyChart');
const refillForm    = document.getElementById('refillForm');
const refillModalEl = document.getElementById('refillModal');
// *** ADDED THIS REF ***
const refillSubmitBtn = document.getElementById('refillSubmitBtn');

let chart = null;
let currentRange = rangeSel?.value || 'month';

/* ---------- utils ---------- */
function showSkeletons(show) {
  skeletons.forEach(el => el.style.display = show ? 'block' : 'none');
  [kpiContainer, topList, recentList, stockTbody, chartCanvas].forEach(el => {
    if (!el) return;
    if (el.tagName === 'CANVAS') el.style.display = show ? 'none' : 'block';
    else if (show) el.innerHTML = '';
  });
}

function pickStock(data) {
  return data.slots || data.stock || data.medicines || data.v_medicines_state || [];
}

function displayLabel(x) {
  if (!x) return '-';
  const d = new Date(x);
  if (!isNaN(d.getTime())) return d.toLocaleString('th-TH', { dateStyle: 'medium', hour12:false });
  return String(x);
}

/* ---------- core loader ---------- */
async function loadDash(range = currentRange) {
  currentRange = range;
  showSkeletons(true);
  try {
    const r = await fetch(`/dash/data?range=${encodeURIComponent(range)}`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d = await r.json();

    /* KPI */
    const u = d.users || {};
    kpiContainer.innerHTML = `
      <div class="col-md-4"><div class="card shadow-sm kpi-card border-primary"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-muted small">TOTAL USERS</div><div class="h4 fw-bold mb-0">${u.total_users ?? 0}</div></div><div class="kpi-icon text-primary"><i class="fa-solid fa-users"></i></div></div></div></div>
      <div class="col-md-4"><div class="card shadow-sm kpi-card border-success"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-muted small">ACTIVE (7 DAYS)</div><div class="h4 fw-bold mb-0">${u.dau_7d ?? 0}</div></div><div class="kpi-icon text-success"><i class="fa-solid fa-user-check"></i></div></div></div></div>
      <div class="col-md-4"><div class="card shadow-sm kpi-card border-warning"><div class="card-body d-flex justify-content-between align-items-center"><div><div class="text-muted small">ACTIVE (30 DAYS)</div><div class="h4 fw-bold mb-0">${u.mau_30d ?? 0}</div></div><div class="kpi-icon text-warning"><i class="fa-solid fa-user-clock"></i></div></div></div></div>`;

    /* Stock table + refill dropdown */
    const stock = pickStock(d);
    if (Array.isArray(stock) && stock.length) {
      stockTbody.innerHTML = stock.map(x => {
        const cs  = Number(x.current_stock ?? 0);
        const thr = Number(x.low_stock_thr ?? 0);
        let badge = `<span class="badge bg-success">In Stock</span>`;
        if (cs <= 0) badge = `<span class="badge bg-danger">Out of Stock</span>`;
        else if (cs <= thr) badge = `<span class="badge bg-warning text-dark">Low Stock</span>`;
        return `<tr><td>#${x.slot ?? '-'}</td><td class="text-start">${x.medicine_name ?? '-'}</td><td>${cs}</td><td>${(x.low_stock_thr ?? '-')}</td><td>${badge}</td></tr>`;
      }).join('');
      refillMedicine.innerHTML = stock.map(x => `<option value="${x.medicine_id ?? ''}" ${x.medicine_id ? '' : 'disabled'}>${x.medicine_name ?? '‚Äî'} (slot #${x.slot ?? '-'})</option>`).join('');
    } else {
      stockTbody.innerHTML = `<tr><td colspan="5" class="text-muted text-center">No stock data</td></tr>`;
      refillMedicine.innerHTML = '';
    }

    /* Chart */
    const series = Array.isArray(d.dispense_series) ? d.dispense_series : [];
    const labels = series.map(s => displayLabel(s.label));
    const data   = series.map(s => Number(s.count ?? s.cnt ?? 0));
    if (!chart) {
      chart = new Chart(chartCanvas, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Dispensed', data, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.12)', fill: true, tension: 0.3, pointRadius: 2 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update('none');
    }

    /* Top meds */
    const top = Array.isArray(d.top_meds) ? d.top_meds : [];
    topList.innerHTML = top.length ? top.map(x => `<li class="list-group-item d-flex justify-content-between align-items-center">${x.med ?? x.medicine_name ?? '-'}<span class="badge bg-primary rounded-pill">${x.cnt ?? x.count ?? 0}</span></li>`).join('') : `<li class="list-group-item text-muted">No data</li>`;

    /* Recent users */
    const recent = Array.isArray(d.recent_users) ? d.recent_users.slice(0, 5) : [];
    recentList.innerHTML = recent.length ? recent.map(x => `<li class="list-group-item d-flex justify-content-between align-items-center py-3 px-3"><div class="d-flex align-items-center"><div class="me-3 text-muted"><i class="fa-solid fa-user-circle fs-4"></i></div><div><b>${x.username ?? '-'}</b><span class="text-muted">¬∑ ${x.symptom ?? '-'}</span><div class="small text-primary">${x.recommended_medicine ?? '-'}</div></div></div><span class="text-muted small">${x.created_at ? new Date(x.created_at).toLocaleString('th-TH') : '-'}</span></li>`).join('') : `<li class="list-group-item text-muted">No recent users</li>`;

  } catch (err) {
    console.error('loadDash failed:', err);
    kpiContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ <button class="btn btn-danger btn-sm ms-2" onclick="loadDash()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button></div></div>`;
  } finally {
    showSkeletons(false);
  }
}

/* ---------- refill via fetch (no page reload) ---------- */
refillForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const medId = refillMedicine.value;
  const qty   = document.getElementById('refillQty').value;
  if (!medId || !qty) return;

  try {
    // *** FIXED: Use correct button reference ***
    refillSubmitBtn.disabled = true;
    refillSubmitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å`;

    const res = await fetch('/admin/refill', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams({ medicine_id: medId, qty })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok || json.ok === false) throw new Error(json.error || `HTTP ${res.status}`);
    
    const modal = bootstrap.Modal.getInstance(refillModalEl) || new bootstrap.Modal(refillModalEl);
    modal.hide();
    
    await loadDash(currentRange);
  } catch (err) {
    console.error('Refill failed:', err);
    alert('‡πÄ‡∏ï‡∏¥‡∏°‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
  } finally {
    // *** FIXED: Use correct button reference ***
    refillSubmitBtn.disabled = false;
    refillSubmitBtn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
  }
});

/* ---------- range filter ---------- */
rangeSel?.addEventListener('change', (e) => loadDash(e.target.value));

/* ---------- first load ---------- */
loadDash(currentRange);
</script>

</body>
</html>