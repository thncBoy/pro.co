<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>กำลังจ่ายยา…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- no-cache กันเบราเซอร์แคช -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg,#e8f7ff 0%,#f7fbff 100%);
      font-family: "Prompt","Noto Sans Thai",system-ui,Arial,sans-serif;
    }
    .card-wrap{
      max-width: 720px; width: 100%; border-radius: 24px; padding: 28px;
      box-shadow: 0 12px 40px rgba(0,0,0,.08);
      background:#fff;
    }
    .pill { font-size: 56px; color:#0d6efd; }
    .spinner-border { width:3.5rem; height:3.5rem; }
    .sec-title{ font-weight:700; color:#0d6efd; }
    .advice-box{ background:#f8fbff; border:1px dashed #b6d6ff; border-radius:16px; padding:16px; }
  </style>
</head>
<body>
  <div class="card-wrap">
    <div class="text-center">
      <div class="pill mb-2"><i class="bi bi-capsule-pill"></i></div>
      <div class="spinner-border text-primary" role="status"></div>
      <h3 class="mt-3 mb-1">กำลังจ่ายยา โปรดรอสักครู่…</h3>
      <div class="text-muted">รายการยา: <span class="fw-semibold">{{ medicine }}</span></div>
    </div>

    <hr class="my-4">

    <div>
      <div class="sec-title mb-2"><i class="bi bi-info-circle"></i> คำแนะนำจากแพทย์ระหว่างรอ</div>
      <div class="advice-box">
        {{ doctor_advice }}
      </div>
    </div>

    <div class="mt-3 text-center text-muted" id="timer">กำลังตรวจสอบสถานะการจ่ายยา…</div>
  </div>

<!-- loading_dispense.html (เฉพาะ <script> ส่วนล่าง) -->
  <script>
    // ค่าพื้นฐาน (รับจาก template)
    const HARD_TIMEOUT_MS = {{ max_wait_ms|default(60000) }};   // เช่น 60000 = 60 วิ
    const POLL_EVERY_MS   = {{ poll_every_ms|default(400) }};   // เช่น 400 ms
  
    // ตั้ง deadline รวม (กันกรณีอุปกรณ์ไม่ตอบ)
    const hardDeadline = Date.now() + HARD_TIMEOUT_MS;
  
    const statusEl   = document.getElementById('status-text');     // ถ้ามี element แสดงสถานะ
    const noteEl     = document.getElementById('note-text');       // ถ้ามี element หมายเหตุ
    const adviceBox  = document.getElementById('advice-box');      // กล่องคำแนะนำแพทย์ (จะคงแสดงตลอด)
    // หมายเหตุ: ถ้าไม่มี id เหล่านี้ใน DOM ไม่เป็นไร โค้ดจะวิ่งได้อยู่
  
    async function pollOnce() {
      try {
        const r = await fetch('/iot/status', { cache: 'no-store' });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'bad status');
  
        const st = data.status || {};
        const busy = !!st.busy;            // true = “หมุนอยู่ หรือ post-check ยังไม่จบ”
        const dispensed = !!st.dispensed;  // true = เซ็นเซอร์ยืนยันพบน้ำหนัก/วัตถุแล้ว
  
        // อัปเดต UI นิดหน่อย (optional)
        if (statusEl) {
          if (busy) {
            statusEl.textContent = 'กำลังจ่ายยา/ตรวจสอบ...';
          } else {
            statusEl.textContent = 'สรุปผลจากเซ็นเซอร์...';
          }
        }
        if (noteEl && typeof st.distance_cm === 'number') {
          noteEl.textContent = `ระยะเซ็นเซอร์ ~ ${st.distance_cm.toFixed(1)} cm`;
        }
  
        // ตัดสินผล “เฉพาะเมื่อ busy=false”
        if (!busy) {
          if (dispensed) {
            // เซ็นเซอร์ยืนยันแล้ว → success
            // ใช้ replace กันปุ่ม Back พาผู้ใช้กลับมาหน้านี้
            window.location.replace('/dispense_success');
            return;
          } else {
            // ไม่พบของตกในถาด → ให้ไปหน้าลองใหม่
            window.location.replace('/dispense_failed');
            return;
          }
        }
  
        // ยัง busy → ตรวจ hard timeout
        if (Date.now() > hardDeadline) {
          window.location.replace('/dispense_failed'); // ครบเวลาแล้ว
          return;
        }
  
      } catch (e) {
        // ปัญหา network ก็ถือเป็น “ยังไม่จบ” ให้รอจน hard timeout
        if (Date.now() > hardDeadline) {
          window.location.replace('/dispense_failed');
          return;
        }
      }
  
      // โพลล์ต่อ
      setTimeout(pollOnce, POLL_EVERY_MS);
    }
  
    // เริ่มโพลล์
    setTimeout(pollOnce, POLL_EVERY_MS);
  </script>
  
    

</body>
</html>
