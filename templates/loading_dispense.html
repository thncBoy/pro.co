<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>กำลังจ่ายยา…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ min-height:100vh; display:flex; align-items:center; justify-content:center; background:#f7fbff; }
    .card-wrap{ max-width:720px; width:100%; border-radius:24px; padding:28px; box-shadow:0 12px 40px rgba(0,0,0,.08); background:#fff; }
  </style>
</head>
<body>
  <div class="card-wrap">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
      <h3 class="mt-3 mb-1">กำลังจ่ายยา โปรดรอสักครู่…</h3>
      <div class="text-muted">รายการยา: <span class="fw-semibold">{{ medicine }}</span></div>
    </div>

    <hr class="my-4">

    <div>
      <div class="fw-bold mb-2 text-primary">คำแนะนำเพิ่มเติมจากแพทย์</div>
      <div class="p-3 border rounded" id="advice-box">
        {{ doctor_advice }}
      </div>
      <!-- ปุ่มฟังซ้ำ (เผื่อโดนบล็อกเสียงอัตโนมัติ) -->
      <button id="replayBtn" type="button" class="btn btn-outline-primary btn-sm mt-2">
        ▶️ ฟังคำแนะนำอีกครั้ง
      </button>
      <button id="skipBtn" type="button" class="btn btn-outline-secondary btn-sm mt-2 ms-2">
        ⏹️ ข้ามเสียง
      </button>
    </div>

    <div class="mt-3 text-center text-muted" id="timer" aria-live="polite">
      กำลังตรวจสอบสถานะการจ่ายยา…
  </div>
  </div>

  {# 1) ถ้ามีไฟล์เสียงให้เล่นก่อน #}
  {% if audio_url %}
    <audio id="advice-audio" src="{{ audio_url }}" preload="auto" autoplay playsinline></audio>
    <script>
      const audioEl = document.getElementById('advice-audio');
      // ป้องกัน autoplay ถูกบล็อก
      audioEl?.play().catch(() => {
        const oncePlay = () => { audioEl.play().catch(()=>{}); document.removeEventListener('click', oncePlay, true); };
        document.addEventListener('click', oncePlay, true);
      });
      document.getElementById('replayBtn')?.addEventListener('click', () => {
        audioEl.currentTime = 0;
        audioEl.play().catch(()=>{});
      });
      document.getElementById('skipBtn')?.addEventListener('click', () => {
        audioEl.pause();
        audioEl.currentTime = 0;
      });
    </script>
  {% else %}
  {# 2) ไม่มีไฟล์เสียง → ใช้ TTS ภาษาไทย แบบ robust #}
  <script>
      (function(){
        const raw = {{ doctor_advice|tojson }};
        const text = (raw||"").replace(/<[^>]+>/g,"").trim();
        if (!text || !('speechSynthesis' in window)) return;

        let thaiVoice = null, spoke = false;

        function pickThai() {
          const voices = window.speechSynthesis.getVoices() || [];
          thaiVoice = voices.find(v => (v.lang||"").toLowerCase().startsWith("th")) || null;
        }

        function speak(txt) {
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(txt);
          u.lang = 'th-TH';
          u.rate = 0.95; u.pitch = 1.0;
          if (thaiVoice) u.voice = thaiVoice;
          try { window.speechSynthesis.speak(u); spoke = true; } catch(e){}
        }

        // ครั้งแรก: รอ voices มาก่อน
        window.speechSynthesis.onvoiceschanged = () => {
          pickThai();
          if (!spoke) speak(text);
        };
        // กันกรณี onvoiceschanged ไม่ยิง
        setTimeout(()=>{ if(!thaiVoice) pickThai(); if(!spoke) speak(text); }, 700);

        // ปุ่มฟังซ้ำ / fallback เมื่อโดนบล็อกเสียงออโต้
        const replay = () => speak(text);
        document.getElementById('replayBtn')?.addEventListener('click', replay);
        document.getElementById('skipBtn')?.addEventListener('click', () => {
          window.speechSynthesis.cancel();
        });
        document.addEventListener('click', ()=>{ if(!spoke) replay(); }, {once:true, capture:true});
      })();
    </script>
  {% endif %}

  <!-- โพลสถานะ + ตัวนับเวลา -->
  <script>
    const HARD_TIMEOUT_MS = {{ max_wait_ms|default(60000) }};
    const POLL_EVERY_MS   = {{ poll_every_ms|default(400) }};
    const startTs = Date.now();
    const deadline = startTs + HARD_TIMEOUT_MS;
    const timerEl = document.getElementById('timer');

    let pollTimer = null;
    let tickTimer = null;
    let navigating = false;

    function toSec(ms){ return Math.max(0, Math.ceil(ms/1000)); }

    function updateTimerText() {
      const left = deadline - Date.now();
      timerEl.textContent = left > 0
        ? `กำลังตรวจสอบสถานะการจ่ายยา… (เหลือประมาณ ${toSec(left)} วินาที)`
        : `หมดเวลา กรุณาลองใหม่`;
    }

    async function pollOnce() {
      try {
        const r = await fetch('/iot/status', {cache:'no-store'});
        const data = await r.json();
        if (!data.ok) throw new Error(data.error||'bad status');

        const st = data.status || {};
        const busy = !!st.busy;
        const dispensed = !!st.dispensed;

        if (!busy) {
          navigating = true;
          clearInterval(pollTimer); clearInterval(tickTimer);
          window.location.replace(dispensed ? '/dispense_success' : '/dispense_failed');
            return;
        }

        if (Date.now() > deadline) {
          navigating = true;
          clearInterval(pollTimer); clearInterval(tickTimer);
          window.location.replace('/dispense_failed');
          return;
        }
      } catch(e) {
        if (Date.now() > deadline) {
          navigating = true;
          clearInterval(pollTimer); clearInterval(tickTimer);
          window.location.replace('/dispense_failed');
          return;
        }
      }
    }

    // เริ่มทำงาน
    updateTimerText();
    tickTimer = setInterval(()=>{ if(!navigating) updateTimerText(); }, 1000);
    pollTimer = setInterval(()=>{ if(!navigating) pollOnce(); }, POLL_EVERY_MS);
  </script>
</body>
</html>
